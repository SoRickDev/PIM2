<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin - CRUD Completo</title>
  <link rel="icon" type="image/png" href="logosesc.png" />
  <style>
    :root {
      --bg: #0b0b0b; --painel: #141414; --neon: #00ff9d; --texto: #fff; --erro: #ff5252;
    }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--texto); margin: 0; }
    
    header { background-color: var(--neon); color: #000; padding: 15px; text-align: center; font-weight: bold; font-size: 1.3em; position: relative; }
    .logout-btn { position: absolute; right: 20px; top: 12px; background-color: var(--erro); border: none; color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }

    .container { padding: 20px; max-width: 1100px; margin: 0 auto; }

    /* Stats */
    .stats-grid { display: flex; gap: 15px; margin-bottom: 20px; }
    .stat-box { flex: 1; background: var(--painel); padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center; box-shadow: 0 0 10px #00ff9d11; }
    .stat-num { font-size: 2em; color: var(--neon); font-weight: bold; display: block; }

    /* Abas de Navegação */
    .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-btn { flex: 1; background: #222; color: #fff; border: 1px solid #333; padding: 10px; cursor: pointer; font-weight: bold; }
    .tab-btn.active { background: var(--neon); color: #000; border-color: var(--neon); }

    /* Tabelas */
    .table-container { background: var(--painel); padding: 20px; border-radius: 10px; display: none; }
    .table-container.active { display: block; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 10px; text-align: left; }
    th { background-color: #1f1f1f; color: var(--neon); }
    
    /* Botões de Ação */
    .btn-acao { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; }
    .btn-edit { background-color: #ffa726; color: #000; }
    .btn-del { background-color: var(--erro); color: #fff; }

    /* Modal de Edição */
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
    .modal-box { background: var(--painel); padding: 30px; width: 400px; border-radius: 10px; border: 2px solid var(--neon); }
    .modal-box h2 { color: var(--neon); margin-top: 0; }
    .modal-box input { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; }
    .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
  </style>
</head>
<body>

  <header>
    Painel Administrativo - Gestão Completa
    <button class="logout-btn" onclick="logout()">Sair</button>
  </header>

  <div class="container">
    <div class="stats-grid">
      <div class="stat-box"><span class="stat-num" id="st-alunos">0</span> Alunos</div>
      <div class="stat-box"><span class="stat-num" id="st-profs">0</span> Professores</div>
      <div class="stat-box"><span class="stat-num" id="st-turmas">0</span> Turmas</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="mudarAba('alunos')">Gerenciar Alunos</button>
      <button class="tab-btn" onclick="mudarAba('profs')">Gerenciar Professores</button>
    </div>

    <div id="tab-alunos" class="table-container active">
      <h2 style="color:var(--neon)">Lista de Alunos</h2>
      <table>
        <thead><tr><th>Nome</th><th>Email</th><th>Curso</th><th>Ações</th></tr></thead>
        <tbody id="lista-alunos"></tbody>
      </table>
    </div>

    <div id="tab-profs" class="table-container">
      <h2 style="color:var(--neon)">Lista de Professores</h2>
      <table>
        <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Ações</th></tr></thead>
        <tbody id="lista-profs"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="modalEditar">
    <div class="modal-box">
      <h2>Editar Usuário</h2>
      <input type="hidden" id="edit-id">
      <label>Nome:</label>
      <input type="text" id="edit-nome">
      <label>Email:</label>
      <input type="email" id="edit-email">
      <label>Telefone:</label>
      <input type="text" id="edit-tel">
      
      <div class="modal-btns">
        <button class="tab-btn active" onclick="salvarEdicao()">Salvar</button>
        <button class="tab-btn" style="background:#333" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const API = `http://${window.location.hostname}:5000`;
    const token = localStorage.getItem("token");

    // Inicialização
    if(!token) window.location.href = "index.html";
    carregarDados();

    async function carregarDados() {
      try {
        const res = await fetch(`${API}/api/admin/dashboard`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if(res.status === 403) { alert("Acesso negado!"); logout(); }
        const data = await res.json();

        // Stats
        document.getElementById("st-alunos").textContent = data.stats.alunos;
        document.getElementById("st-profs").textContent = data.stats.professores;
        document.getElementById("st-turmas").textContent = data.stats.turmas;

        // Preencher Alunos
        const tbAlunos = document.getElementById("lista-alunos");
        tbAlunos.innerHTML = "";
        data.alunos.forEach(a => {
          tbAlunos.innerHTML += `
            <tr>
              <td>${a.nome}</td>
              <td>${a.email}</td>
              <td>${a.nome_curso}</td>
              <td>
                <button class="btn-acao btn-edit" onclick="abrirModal('${a.id_user}', '${a.nome}', '${a.email}', '${a.telefone}')">Editar</button>
                <button class="btn-acao btn-del" onclick="excluirUsuario('${a.id_user}')">Excluir</button>
              </td>
            </tr>`;
        });

        // Preencher Professores
        const tbProfs = document.getElementById("lista-profs");
        tbProfs.innerHTML = "";
        data.professores.forEach(p => {
          tbProfs.innerHTML += `
            <tr>
              <td>${p.nome}</td>
              <td>${p.email}</td>
              <td>${p.telefone}</td>
              <td>
                <button class="btn-acao btn-edit" onclick="abrirModal('${p.id_user}', '${p.nome}', '${p.email}', '${p.telefone}')">Editar</button>
                <button class="btn-acao btn-del" onclick="excluirUsuario('${p.id_user}')">Excluir</button>
              </td>
            </tr>`;
        });

      } catch(err) { console.error(err); alert("Erro de conexão."); }
    }

    // ================= LÓGICA DE CRUD =================

    // 1. Mudar Abas
    function mudarAba(aba) {
      document.querySelectorAll('.table-container').forEach(d => d.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      
      document.getElementById(`tab-${aba}`).classList.add('active');
      event.target.classList.add('active');
    }

    // 2. Excluir
    async function excluirUsuario(id) {
      if(!confirm("Tem certeza? Isso apagará todo o histórico deste usuário.")) return;

      try {
        const res = await fetch(`${API}/api/admin/usuario/${id}`, {
          method: 'DELETE',
          headers: { "Authorization": `Bearer ${token}` }
        });
        if(res.ok) {
          alert("Usuário excluído!");
          carregarDados();
        } else {
          alert("Erro ao excluir.");
        }
      } catch(err) { alert("Erro de conexão."); }
    }

    // 3. Editar (Abrir Modal)
    function abrirModal(id, nome, email, tel) {
      document.getElementById("edit-id").value = id;
      document.getElementById("edit-nome").value = nome;
      document.getElementById("edit-email").value = email;
      document.getElementById("edit-tel").value = tel;
      document.getElementById("modalEditar").style.display = "flex";
    }

    function fecharModal() {
      document.getElementById("modalEditar").style.display = "none";
    }

    async function salvarEdicao() {
      const id = document.getElementById("edit-id").value;
      const body = {
        nome: document.getElementById("edit-nome").value,
        email: document.getElementById("edit-email").value,
        telefone: document.getElementById("edit-tel").value
      };

      try {
        const res = await fetch(`${API}/api/admin/usuario/${id}`, {
          method: 'PUT',
          headers: { 
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json" 
          },
          body: JSON.stringify(body)
        });
        if(res.ok) {
          alert("Dados atualizados!");
          fecharModal();
          carregarDados();
        } else {
          alert("Erro ao atualizar.");
        }
      } catch(err) { alert("Erro de conexão."); }
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }
  </script>
</body>
</html>